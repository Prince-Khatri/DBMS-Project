{% extends "base.html" %}

{% block title %}Chat - Chat App{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <!-- User Profile -->
        <div class="d-flex align-items-center mb-4">
            <img src="https://via.placeholder.com/40" alt="Profile" class="profile-pic me-2">
            <div>
                <h6 class="mb-0">{{ current_user.Name }}</h6>
                <small class="text-muted">
                    <span class="status-indicator online"></span>
                    Online
                </small>
            </div>
        </div>

        <!-- Tabs for Users and Groups -->
        <ul class="nav nav-tabs mb-3" id="chatTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="users-tab" data-bs-toggle="tab" href="#users" role="tab">
                    <i class="fas fa-users"></i> Users
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="groups-tab" data-bs-toggle="tab" href="#groups" role="tab">
                    <i class="fas fa-user-friends"></i> Groups
                </a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="chatTabContent">
            <!-- Users List -->
            <div class="tab-pane fade show active" id="users" role="tabpanel">
                <div class="list-group" id="usersList">
                    <!-- Users will be populated here -->
                </div>
            </div>

            <!-- Groups List -->
            <div class="tab-pane fade" id="groups" role="tabpanel">
                <div class="mb-3">
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                        <i class="fas fa-plus"></i> Create Group
                    </button>
                </div>
                <div class="list-group" id="groupsList">
                    <!-- Groups will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="chat-main">
        <div id="chatHeader" class="mb-3">
            <h5 id="currentChatName">Select a chat to start messaging</h5>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be populated here -->
        </div>

        <div class="message-input">
            <textarea class="form-control" id="messageInput" rows="2" placeholder="Type a message..." disabled></textarea>
            <button class="btn btn-primary" id="sendButton" disabled>
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<!-- Create Group Modal -->
<div class="modal fade" id="createGroupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createGroupForm">
                    <div class="mb-3">
                        <label for="groupName" class="form-label">Group Name</label>
                        <input type="text" class="form-control" id="groupName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Add Members</label>
                        <div id="groupMembersList">
                            <!-- User checkboxes will be populated here -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createGroup()">Create Group</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const API_BASE = 'http://127.0.0.1:5000';
let currentUser = JSON.parse(localStorage.getItem('user'));
let currentChat = null;
let lastMessageId = 0;
let pollInterval = null;

// Initialize the chat interface
document.addEventListener('DOMContentLoaded', () => {
    if (!currentUser) {
        window.location.href = '/';
        return;
    }
    
    loadUsers();
    loadGroups();
});

// Load users list
async function loadUsers() {
    try {
        const response = await fetch(`${API_BASE}/users`);
        const data = await response.json();
        if (data.status === 'success') {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = data.users
                .filter(user => user.User_Id !== currentUser.User_Id)
                .map(user => `
                    <a href="#" class="list-group-item list-group-item-action user-list-item" 
                       onclick="selectChat('user', ${user.User_Id}, '${user.Name}')">
                        <div class="d-flex align-items-center">
                            <img src="https://via.placeholder.com/32" alt="${user.Name}" class="profile-pic me-2">
                            <div>
                                <h6 class="mb-0">${user.Name}</h6>
                                <small class="text-muted">
                                    <span class="status-indicator offline" id="status-${user.User_Id}"></span>
                                    Offline
                                </small>
                            </div>
                        </div>
                    </a>
                `).join('');
        }
    } catch (error) {
        console.error('Error loading users:', error);
    }
}

// Load groups list
async function loadGroups() {
    try {
        const response = await fetch(`${API_BASE}/groups/${currentUser.User_Id}`);
        const data = await response.json();
        if (data.status === 'success') {
            const groupsList = document.getElementById('groupsList');
            groupsList.innerHTML = data.groups.map(group => `
                <a href="#" class="list-group-item list-group-item-action group-list-item"
                   onclick="selectChat('group', ${group.group_id}, '${group.group_name}')">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-user-friends me-2"></i>
                        <div>
                            <h6 class="mb-0">${group.group_name}</h6>
                            <small class="text-muted">Group</small>
                        </div>
                    </div>
                </a>
            `).join('');
        }
    } catch (error) {
        console.error('Error loading groups:', error);
    }
}

// Select a chat (user or group)
async function selectChat(type, id, name) {
    // Clear existing polling
    if (pollInterval) {
        clearInterval(pollInterval);
    }

    currentChat = { type, id, name };
    document.getElementById('currentChatName').textContent = name;
    document.getElementById('messageInput').disabled = false;
    document.getElementById('sendButton').disabled = false;
    
    // Update active state in lists
    document.querySelectorAll('.user-list-item, .group-list-item').forEach(item => {
        item.classList.remove('active-chat');
    });
    event.currentTarget.classList.add('active-chat');
    
    // Load chat history and start polling
    await loadChatHistory();
    startPolling();
}

// Start polling for new messages
function startPolling() {
    pollInterval = setInterval(async () => {
        if (currentChat) {
            await checkNewMessages();
        }
    }, 3000); // Poll every 3 seconds
}

// Check for new messages
async function checkNewMessages() {
    try {
        const url = currentChat.type === 'user' 
            ? `${API_BASE}/chat_history?sender_user_id=${currentUser.User_Id}&receiver_user_id=${currentChat.id}`
            : `${API_BASE}/chat_history?receiver_group_id=${currentChat.id}`;
            
        const response = await fetch(url);
        const messages = await response.json();
        
        if (messages.length > 0) {
            const lastMessage = messages[messages.length - 1];
            if (lastMessage.message_id > lastMessageId) {
                // Only append new messages
                const newMessages = messages.filter(m => m.message_id > lastMessageId);
                newMessages.forEach(message => appendMessage(message));
                lastMessageId = lastMessage.message_id;
            }
        }
    } catch (error) {
        console.error('Error checking new messages:', error);
    }
}

// Load chat history
async function loadChatHistory() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = '';
    lastMessageId = 0;
    
    try {
        const url = currentChat.type === 'user' 
            ? `${API_BASE}/chat_history?sender_user_id=${currentUser.User_Id}&receiver_user_id=${currentChat.id}`
            : `${API_BASE}/chat_history?receiver_group_id=${currentChat.id}`;
            
        const response = await fetch(url);
        const messages = await response.json();
        
        messages.forEach(message => {
            appendMessage(message);
            if (message.message_id > lastMessageId) {
                lastMessageId = message.message_id;
            }
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
    } catch (error) {
        console.error('Error loading chat history:', error);
    }
}

// Append a message to the chat
function appendMessage(message) {
    const chatMessages = document.getElementById('chatMessages');
    const isSent = message.sender_user_id === currentUser.User_Id;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
    messageDiv.innerHTML = `
        <div class="message-content">
            <small class="text-muted">${message.sender_name}</small><br>
            ${message.content}
        </div>
        <small class="text-muted">${new Date(message.sent_at).toLocaleTimeString()}</small>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Send a message
async function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const content = messageInput.value.trim();
    
    if (!content || !currentChat) return;
    
    try {
        const messageData = {
            sender_user_id: currentUser.User_Id,
            content: content,
            ...(currentChat.type === 'user' 
                ? { receiver_user_id: currentChat.id }
                : { receiver_group_id: currentChat.id })
        };
        
        const response = await fetch(`${API_BASE}/send_message`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(messageData)
        });
        
        const data = await response.json();
        if (data.status === 'success') {
            messageInput.value = '';
            appendMessage(data.data);
            lastMessageId = data.data.message_id;
        }
    } catch (error) {
        console.error('Error sending message:', error);
    }
}

// Create a new group
async function createGroup() {
    const groupName = document.getElementById('groupName').value.trim();
    const selectedMembers = Array.from(document.querySelectorAll('#groupMembersList input:checked'))
        .map(input => parseInt(input.value));
    
    if (!groupName || selectedMembers.length === 0) return;
    
    try {
        const response = await fetch(`${API_BASE}/create_group`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                group_name: groupName,
                admin_email: currentUser.Email,
                members: selectedMembers
            })
        });
        
        const data = await response.json();
        if (data.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('createGroupModal')).hide();
            loadGroups();
        }
    } catch (error) {
        console.error('Error creating group:', error);
    }
}

// Update user status
function updateUserStatus(userId, status) {
    const statusIndicator = document.getElementById(`status-${userId}`);
    if (statusIndicator) {
        statusIndicator.className = `status-indicator ${status === 'online' ? 'online' : 'offline'}`;
        statusIndicator.nextSibling.textContent = status === 'online' ? 'Online' : 'Offline';
    }
}

// Logout
function logout() {
    if (pollInterval) {
        clearInterval(pollInterval);
    }
    localStorage.removeItem('user');
    window.location.href = '/';
}

// Event Listeners
document.getElementById('messageInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

document.getElementById('sendButton').addEventListener('click', sendMessage);
</script>
{% endblock %} 